FC=nagfor_beta

###############################################################################
# nagfor_beta = NAG Fortran Compiler Release 5.3(842)
#    - Works!
FFLAGS_nagfor_beta=-f2003 -colour -v -fpp
FFLAGS_nagfor_beta+=-mdir $(LIBDIR) -I $(LIBDIR) 
FFLAGS_nagfor_beta+=-O0 -C=all -g90

# nagfor = NAG Fortran Compiler Release 5.2(752)
#    - Panic: /tmp/design_by_contract.018101.f90: Unexpected expr node type 0
FFLAGS_nagfor=$(FFLAGS_nagfor_beta)

###############################################################################
# gfortran = GNU Fortran (Ubuntu 4.4.3-4ubuntu5) 4.4.3
#    - very limited support for f2003
FFLAGS_gfortran=-std=f2008 
FFLAGS_gfortran+=-J $(LIBDIR)
FFLAGS_gfortran+=-DFC_NO_FINAL_SUPPORT -DFC_NO_SAME_TYPE_AS_SUPPORT
FFLAGS_gfortran+=-O0 -g

# gfortran_beta = GNU Fortran (GCC) 4.7.0 20110326 (experimental)
FFLAGS_gfortran_beta=$(FFLAGS_gfortran)

###############################################################################
# g95 = G95 (GCC 4.0.3 (g95 0.92!) Jun  3 2009)
#    - very limited support for f2003
FFLAGS_g95=-std=f2003 -fmod=$(LIBDIR) -DFC_NO_FINAL_SUPPORT

###############################################################################
# ifort = ifort (IFORT) 12.0.2 20110112
#    - no support for SELECT TYPE
#    - no support for ALLOCATE( ... source=... )
FFLAGS_ifort= -module $(LIBDIR) -fpp -g -check -warn -DFC_NO_FINAL_SUPPORT -DFC_NO_SAME_TYPE_AS_SUPPORT -free -Tf

###############################################################################

FFLAGS=$(FFLAGS_$(FC))

OBJECTS= \
	error_handling_error.o \
	error_handling_common_errors.o \
	error_handling_common_wrappers.o \
	error_handling_legacy.o \
	design_by_contract.o \
	error_handling_unit_test.o \
	error_handling.o

%.o: %.f03
	$(FC) -c $(FFLAGS) $^

###############################################################################

LIBDIR=$(FC)_build/
LIBRARY=$(LIBDIR)liberror_handling.a

first: $(LIBRARY)

$(LIBDIR): clean
	mkdir -p -v $(LIBDIR)
$(LIBRARY): $(LIBDIR) $(OBJECTS)
	$(AR) -r -u $@ $(OBJECTS)

veryclean_library:
	$(RM) $(LIBRARY)
	$(RM) -r $(LIBDIR)


###############################################################################
# Autogenerated files
AUTOGENERATED=\
	error_handling_common_wrappers.f03 \
	error_handling_unit_test.f03 \
	error_handling_preprocessing.h \
	autogenerated_types.xml \
	autogenerated_types

AUTOGENERATED_DEPS=
autogenerated: $(AUTOGENERATED)

autogenerated_types: autogenerated_types.o
	$(FC) -o $@ $^
autogenerated_types.xml: autogenerated_types
	./autogenerated_types

error_handling_common_wrappers.f03: error_handling_common_wrappers.xsl autogenerated.xsl error_handling_common_wrappers.xml autogenerated_types.xml
	xsltproc --output "$@" --stringparam isoD `date +"%Y%m%d"` --debug error_handling_common_wrappers.xsl autogenerated.xsl error_handling_common_wrappers.xml
error_handling_unit_test.f03: error_handling_unit_test.xsl autogenerated.xsl error_handling_unit_test.xml autogenerated_types.xml
	xsltproc --output "$@" --stringparam isoD `date +"%Y%m%d"` --debug error_handling_unit_test.xsl autogenerated.xsl error_handling_unit_test.xml
error_handling_preprocessing.h: error_handling_preprocessing.xsl autogenerated.xsl error_handling_unit_test.xml autogenerated_types.xml
	xsltproc --output "$@" --stringparam isoD `date +"%Y%m%d"` --debug error_handling_preprocessing.xsl autogenerated.xsl error_handling_unit_test.xml

clean_autogenerated:
	$(RM) $(AUTOGENERATED)

###############################################################################

clean: clean_autogenerated
	$(RM) *.o *.mod *.g90

veryclean: clean veryclean_library

all: 
	make FC=nagfor
	make FC=nagfor_beta
	make FC=ifort
