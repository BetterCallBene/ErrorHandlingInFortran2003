FC=nagfor_beta

###############################################################################
# As compilers continue to implement Fortran 2003 features, the following 
# macro's are available:
# - FC_NO_SAME_TYPE_AS_SUPPORT, disables same_type_as primitive
# - FC_NO_FINAL_SUPPORT, disables finalisation
# - FC_NO_ALLOCATABLE_DTCOMP, disables allocatable components of a derived type

###############################################################################
# nagfor_beta = NAG Fortran Compiler Release 5.3(842)
#    - Works!
FFLAGS_nagfor_beta=-f2003 -colour -v -fpp
FFLAGS_nagfor_beta+=-mdir $(LIBDIR) -I $(LIBDIR) 
FFLAGS_nagfor_beta+=-O0 -C=all -g90

# nagfor = NAG Fortran Compiler Release 5.2(752)
#    - Panic: /tmp/design_by_contract.018101.f90: Unexpected expr node type 0
FFLAGS_nagfor=$(FFLAGS_nagfor_beta)

###############################################################################
# gfortran = GNU Fortran (GCC) 4.7.0 20111013 (experimental)
#    - no finalisation yet
#    - gfortran_beta -c -std=f2008  -J gfortran_beta_build/ -cpp -O0 -g -DFC_NO_FINAL_SUPPORT error_handling_error.f03
#      f951: internal compiler error: in gfc_get_derived_type, at fortran/trans-types.c:2394
FFLAGS_gfortran_beta=-std=f2008 
FFLAGS_gfortran_beta+=-J $(LIBDIR) -cpp
FFLAGS_gfortran_beta+=-O0 -g
FFLAGS_gfortran_beta+=-DFC_NO_FINAL_SUPPORT -DFC_NO_ALLOCATABLE_DTCOMP

# (old) gfortran = GNU Fortran (Ubuntu 4.4.3-4ubuntu5) 4.4.3
#    - very limited support for f2003
FFLAGS_gfortran=$(FFLAGS_gfortran_beta) -DFC_NO_SAME_TYPE_AS_SUPPORT

###############################################################################
# g95 = G95 (GCC 4.0.3 (g95 0.92!) Jun  3 2009)
#    - very limited support for f2003
FFLAGS_g95=-std=f2003 -fmod=$(LIBDIR) -DFC_NO_FINAL_SUPPORT

###############################################################################
# ifort_beta (IFORT) 12.1.0 20111011
#    - /tmp/ifort_betaewX8Q5.i: catastrophic error: **Internal compiler error: segmentation violation signal raised** Please report this error along with the circumstances in which it occurred in a Software Problem Report.  Note: File and line given may not be explicit cause of this error. compilation aborted for error_handling_unit_test.f03 (code 1)
# ifort_beta (IFORT) 12.1.2 20111128
#    ifort_beta -c -module ifort_beta_build/ -fpp -g -check -warn  -DFC_NO_ALLOCATABLE_DTCOMP -free -Tf error_handling_common_wrappers.f03
#    error_handling_common_wrappers.f03(59): error #6593: The number of expressions in a structure constructor differs from the number of components of the derived type   [ALLOCATION_ERROR]
#                   allocation_error( stat, (/ sizes /) ) )
#    ---------------^
#    ompilation aborted for error_handling_common_wrappers.f03 (code 1)
FFLAGS_ifort_beta= -module $(LIBDIR) -fpp -g -check -warn 
FFLAGS_ifort_beta+=-DFC_NO_ALLOCATABLE_DTCOMP -DFC_NO_DT_CONSTRUCTOR
FFLAGS_ifort_beta+=-free -Tf

# ifort = ifort (IFORT) 12.0.2 20110112
#    - no support for SELECT TYPE
#    - no support for ALLOCATE( ... source=... )
FFLAGS_ifort=$(FFLAGS_ifort_beta)
FFLAGS_ifort+=-DFC_NO_FINAL_SUPPORT -DFC_NO_SAME_TYPE_AS_SUPPORT

###############################################################################

FFLAGS=$(FFLAGS_$(FC))

OBJECTS= \
	error_handling_error.o \
	error_handling_common_errors.o \
	error_handling_common_wrappers.o \
	error_handling_legacy.o \
	design_by_contract.o \
	error_handling_unit_test.o \
	error_handling.o

%.o: %.f03
	$(FC) -c $(FFLAGS) $^

###############################################################################

LIBDIR=$(FC)_build/
LIBRARY=$(LIBDIR)liberror_handling.a

first: $(LIBRARY)

$(LIBDIR): clean
	mkdir -p -v $(LIBDIR)
$(LIBRARY): $(LIBDIR) $(OBJECTS)
	$(AR) -r -u $@ $(OBJECTS)

veryclean_library:
	$(RM) $(LIBRARY)
	$(RM) -r $(LIBDIR)


###############################################################################
# Autogenerated files
AUTOGENERATED=\
	error_handling_common_wrappers.f03 \
	error_handling_unit_test.f03 \
	error_handling_preprocessing.h \
	autogenerated_types.xml \
	autogenerated_types

AUTOGENERATED_DEPS=
autogenerated: $(AUTOGENERATED)

autogenerated_types: autogenerated_types.o
	$(FC) -o $@ $^
autogenerated_types.xml: autogenerated_types
	./autogenerated_types

error_handling_common_wrappers.f03: error_handling_common_wrappers.xsl autogenerated.xsl error_handling_common_wrappers.xml autogenerated_types.xml
	xsltproc --output "$@" --stringparam isoD `date +"%Y%m%d"` --debug error_handling_common_wrappers.xsl autogenerated.xsl error_handling_common_wrappers.xml
error_handling_unit_test.f03: error_handling_unit_test.xsl autogenerated.xsl error_handling_unit_test.xml autogenerated_types.xml
	xsltproc --output "$@" --stringparam isoD `date +"%Y%m%d"` --debug error_handling_unit_test.xsl autogenerated.xsl error_handling_unit_test.xml
error_handling_preprocessing.h: error_handling_preprocessing.xsl autogenerated.xsl error_handling_unit_test.xml autogenerated_types.xml
	xsltproc --output "$@" --stringparam isoD `date +"%Y%m%d"` --debug error_handling_preprocessing.xsl autogenerated.xsl error_handling_unit_test.xml

clean_autogenerated:
	$(RM) $(AUTOGENERATED)

###############################################################################
# Create a default autogenerated version
default:
	@touch autogenerated_types.o autogenerated_types
	@cp -v autogenerated_types.default.xml autogenerated_types.xml
	@$(MAKE) --no-print-directory \
		error_handling_common_wrappers.f03 error_handling_unit_test.f03 error_handling_preprocessing.h
	$(RM) autogenerated_types.o autogenerated_types autogenerated_types.xml

###############################################################################

clean: clean_autogenerated
	$(RM) *.o *.mod *.g90

veryclean: clean veryclean_library

all: 
	make FC=nagfor
	make FC=nagfor_beta
	make FC=ifort
